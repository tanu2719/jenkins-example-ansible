- name: Create Jenkins slave
  hosts: localhost
  vars:
    jenkins_url: "http://localhost:8080"
    jenkins_user: "admin"
    jenkins_password: "admin"
    jenkins_token: "11a60d0059efd55317827d3477a5d041b3"
    slave_config_file: "requirements.json"
  tasks:
    - name: Ensure slave configuration file is present
      ansible.builtin.copy:
        src: "{{ slave_config_file }}"
        dest: "/Users/tanushreerakshit/.jenkins/workspace/ansible"
    - name: Fetch Jenkins Crumb
      ansible.builtin.uri:
        url: "{{ jenkins_url }}/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,%22:%22,//crumb)"
        method: GET
        user: "{{ jenkins_username }}"
        password: "{{ jenkins_password }}"
        status_code: 200
      register: crumb_response
    - name: Create Jenkins slave node
      ansible.builtin.uri:
        url: "{{ jenkins_url }}/computer/doCreateItem"
        method: POST
        user: "admin"
        password: "admin"
        headers:
          Jenkins-Crumb: "{{ crumb_response.json | json_query('crumb') }}"
        body_format: json
        body:
         name: "ansible-slave"
         type: "hudson.slaves.DumbSlave$DescriptorImpl"
         json: "{{ lookup('file', '/Users/tanushreerakshit/.jenkins/workspace/ansible/{{ slave_config_file }}') }}"
        status_code: 200  # Define the expected status code if necessary
        validate_certs: no  # Adjust as needed based on your Jenkins setup
      register: result
